{% extends "base.html" %}

{% block title %}編輯學習筆記{% endblock %}

{% block content %}
<div class="py-4">
    <h1 class="h3 mb-4">編輯學習筆記</h1>
    <form method="POST" action="{{ url_for('notes.edit_note', id=note.id) }}" id="noteForm">
        <div class="mb-3">
            <label for="title" class="form-label">標題</label>
            <input type="text" class="form-control" id="title" name="title" value="{{ note.title }}" required>
        </div>
        
        <!-- New Dynamic Category Section -->
        <div class="mb-3">
            <label for="category-select" class="form-label">分類</label>
            <div class="input-group">
                <select class="form-select" id="category-select" name="category_id" required>
                    <option value="" disabled>請選擇一個分類...</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if note.category_id and category.id == note.category_id %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>
                <button class="btn btn-outline-secondary" type="button" id="add-category-btn" title="新增分類">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div id="add-category-form" class="mt-2" style="display: none;">
                <div class="input-group">
                    <input type="text" id="new-category-name" class="form-control" placeholder="輸入新分類名稱...">
                    <button class="btn btn-success" type="button" id="save-category-btn">儲存</button>
                    <button class="btn btn-danger" type="button" id="cancel-add-category-btn">取消</button>
                </div>
                <div id="category-error" class="form-text text-danger mt-1"></div>
            </div>
        </div>

        <div class="mb-3">
            <label for="content" class="form-label">內容</label>
            <div id="editor"></div>
            <input type="hidden" name="content" id="hiddenContent" value="{{ note.content | e }}">
        </div>
        
        <div class="mb-3">
            <label for="tags" class="form-label">標籤</label>
            <input type="text" class="form-control" id="tags" name="tags" value="{{ note.tags | e }}">
        </div>

        <button type="submit" class="btn btn-success">
            <i class="fas fa-save"></i> 更新
        </button>
        <a href="{{ url_for('notes.view_note', id=note.id) }}" class="btn btn-secondary">
            <i class="fas fa-times"></i> 取消
        </a>
    </form>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/toastui-editor.min.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/toastui-editor-dark.css') }}" />
<script src="{{ url_for('static', filename='js/toastui-editor.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/toastui-editor-zh-tw.min.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get initial content
    const initialContent = document.getElementById('hiddenContent').value;
    
    // Toast UI Editor Setup
    const editor = new toastui.Editor({
        el: document.querySelector('#editor'),
        height: '500px',
        initialEditType: 'wysiwyg',
        previewStyle: 'vertical',
        language: 'zh-TW',
        theme: 'dark',
        usageStatistics: false,
        initialValue: initialContent,
        toolbarItems: [
            ['heading', 'bold', 'italic', 'strike'],
            ['hr', 'quote'],
            ['ul', 'ol', 'task', 'indent', 'outdent'],
            ['table', 'image', 'link'],
            ['code', 'codeblock'],
            ['scrollSync']
        ],
        hooks: {
            addImageBlobHook: async (blob, callback) => {
                const formData = new FormData();
                formData.append('file', blob);

                try {
                    const response = await fetch("{{ url_for('notes.upload_image') }}", {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        alert('圖片上傳失敗: ' + (error.error || '未知錯誤'));
                        return;
                    }

                    const data = await response.json();
                    callback(data.location, blob.name || '圖片');
                } catch (error) {
                    console.error('圖片上傳錯誤:', error);
                    alert('圖片上傳失敗，請稍後再試。');
                }
            }
        }
    });

    // Tagify Setup
    var input = document.querySelector('#tags');
    new Tagify(input);

    // Helper function to convert base64 to blob
    function base64ToBlob(base64, mimeType) {
        const byteCharacters = atob(base64);
        const byteArrays = [];
        for (let i = 0; i < byteCharacters.length; i++) {
            byteArrays.push(byteCharacters.charCodeAt(i));
        }
        return new Blob([new Uint8Array(byteArrays)], { type: mimeType });
    }

    // Helper function to upload image and return new URL
    async function uploadImageBlob(blob, filename) {
        const formData = new FormData();
        formData.append('file', blob, filename);

        try {
            const response = await fetch("{{ url_for('notes.upload_image') }}", {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('上傳失敗');
            }

            const data = await response.json();
            return data.location;
        } catch (error) {
            console.error('圖片上傳錯誤:', error);
            return null;
        }
    }

    // Process all images in markdown before submission
    async function processImagesInMarkdown(markdown) {
        // Regular expression to find markdown images: ![alt](url)
        const imgRegex = /!\[([^\]]*)\]\(([^\)]+)\)/g;
        let match;
        const replacements = [];

        while ((match = imgRegex.exec(markdown)) !== null) {
            const fullMatch = match[0];
            const alt = match[1];
            const url = match[2];

            // Check if it's a base64 image
            if (url.startsWith('data:image/')) {
                const matches = url.match(/^data:(image\/[^;]+);base64,(.+)$/);
                if (matches) {
                    const mimeType = matches[1];
                    const base64Data = matches[2];
                    const blob = base64ToBlob(base64Data, mimeType);
                    const ext = mimeType.split('/')[1];
                    const filename = `pasted-${Date.now()}.${ext}`;
                    
                    const newUrl = await uploadImageBlob(blob, filename);
                    if (newUrl) {
                        replacements.push({ old: fullMatch, new: `![${alt}](${newUrl})` });
                    }
                }
            }
            // Check if it's an external URL (not from our server)
            else if (url.startsWith('http://') || url.startsWith('https://')) {
                // Skip if it's already from our server
                if (!url.includes(window.location.hostname)) {
                    try {
                        // Fetch and upload external image
                        const response = await fetch(url);
                        const blob = await response.blob();
                        const ext = blob.type.split('/')[1] || 'jpg';
                        const filename = `external-${Date.now()}.${ext}`;
                        
                        const newUrl = await uploadImageBlob(blob, filename);
                        if (newUrl) {
                            replacements.push({ old: fullMatch, new: `![${alt}](${newUrl})` });
                        }
                    } catch (error) {
                        console.error('外部圖片下載失敗:', url, error);
                    }
                }
            }
        }

        // Apply all replacements
        let processedMarkdown = markdown;
        for (const replacement of replacements) {
            processedMarkdown = processedMarkdown.replace(replacement.old, replacement.new);
        }

        return processedMarkdown;
    }

    // Form Submission: Process images and copy editor content to hidden field
    var form = document.querySelector('#noteForm');
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Show loading indicator
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 處理中...';

        try {
            // Get markdown and process images
            const markdown = editor.getMarkdown();
            const processedMarkdown = await processImagesInMarkdown(markdown);
            
            // Set processed content
            var hiddenContent = document.querySelector('#hiddenContent');
            hiddenContent.value = processedMarkdown;
            
            // Submit the form
            form.submit();
        } catch (error) {
            console.error('提交錯誤:', error);
            alert('提交失敗，請稍後再試。');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        }
    });

    // --- New Dynamic Category Logic ---
    const addCategoryBtn = document.getElementById('add-category-btn');
    const addCategoryForm = document.getElementById('add-category-form');
    const saveCategoryBtn = document.getElementById('save-category-btn');
    const cancelAddCategoryBtn = document.getElementById('cancel-add-category-btn');
    const newCategoryNameInput = document.getElementById('new-category-name');
    const categorySelect = document.getElementById('category-select');
    const categoryError = document.getElementById('category-error');

    addCategoryBtn.addEventListener('click', () => {
        addCategoryForm.style.display = 'block';
        addCategoryBtn.style.display = 'none';
        newCategoryNameInput.focus();
    });

    cancelAddCategoryBtn.addEventListener('click', () => {
        addCategoryForm.style.display = 'none';
        addCategoryBtn.style.display = 'block';
        newCategoryNameInput.value = '';
        categoryError.textContent = '';
    });

    saveCategoryBtn.addEventListener('click', async () => {
        const name = newCategoryNameInput.value.trim();
        if (!name) {
            categoryError.textContent = '分類名稱不能為空。';
            return;
        }
        categoryError.textContent = '';

        try {
            const response = await fetch("{{ url_for('notes.add_category') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ name: name })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || '儲存失敗，請稍後再試。');
            }

            if (!categorySelect.querySelector(`option[value="${data.id}"]`)) {
                const newOption = new Option(data.name, data.id);
                categorySelect.add(newOption);
            }
            
            categorySelect.value = data.id;
            cancelAddCategoryBtn.click();

        } catch (error) {
            categoryError.textContent = error.message;
        }
    });
});
</script>
{% endblock %}