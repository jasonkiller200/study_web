{% extends "base.html" %}

{% block title %}新增學習筆記{% endblock %}

{% block content %}
<div class="py-4">
    <h1 class="h3 mb-4">新增學習筆記</h1>
    <form method="POST" action="{{ url_for('notes.add_note') }}" id="noteForm">
        <div class="mb-3">
            <label for="title" class="form-label">標題</label>
            <input type="text" class="form-control" id="title" name="title" value="{{ note.title if note is defined else '' }}" required>
        </div>
        
        <!-- New Dynamic Category Section -->
        <div class="mb-3">
            <label for="category-select" class="form-label">分類</label>
            <div class="input-group">
                <select class="form-select" id="category-select" name="category_id" required>
                    <option value="" selected disabled>請選擇一個分類...</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
                <button class="btn btn-outline-secondary" type="button" id="add-category-btn" title="新增分類">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div id="add-category-form" class="mt-2" style="display: none;">
                <div class="input-group">
                    <input type="text" id="new-category-name" class="form-control" placeholder="輸入新分類名稱...">
                    <button class="btn btn-success" type="button" id="save-category-btn">儲存</button>
                    <button class="btn btn-danger" type="button" id="cancel-add-category-btn">取消</button>
                </div>
                <div id="category-error" class="form-text text-danger mt-1"></div>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="content" class="form-label">內容</label>
            <div id="editor"></div>
            <input type="hidden" name="content" id="hiddenContent">
        </div>
        
        <div class="mb-3">
            <label for="tags" class="form-label">標籤</label>
            <input type="text" class="form-control" id="tags" name="tags" value="{{ note.tags if note is defined else '' }}">
        </div>

        <button type="submit" class="btn btn-success">
            <i class="fas fa-save"></i> 儲存
        </button>
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
            <i class="fas fa-times"></i> 取消
        </a>
    </form>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/toastui-editor.min.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/toastui-editor-dark.css') }}" />
<script src="{{ url_for('static', filename='js/toastui-editor.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/toastui-editor-zh-tw.min.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toast UI Editor Setup
    const editor = new toastui.Editor({
        el: document.querySelector('#editor'),
        height: '500px',
        initialEditType: 'wysiwyg',
        previewStyle: 'vertical',
        language: 'zh-TW',
        theme: 'dark',
        usageStatistics: false,
        toolbarItems: [
            ['heading', 'bold', 'italic', 'strike'],
            ['hr', 'quote'],
            ['ul', 'ol', 'task', 'indent', 'outdent'],
            ['table', 'image', 'link'],
            ['code', 'codeblock'],
            ['scrollSync']
        ]
    });

    // Tagify Setup
    var input = document.querySelector('#tags');
    new Tagify(input);

    // Form Submission: Copy editor content to hidden field (as Markdown)
    var form = document.querySelector('#noteForm');
    form.addEventListener('submit', function(e) {
        var hiddenContent = document.querySelector('#hiddenContent');
        hiddenContent.value = editor.getMarkdown();
    });

    // --- New Dynamic Category Logic ---
    const addCategoryBtn = document.getElementById('add-category-btn');
    const addCategoryForm = document.getElementById('add-category-form');
    const saveCategoryBtn = document.getElementById('save-category-btn');
    const cancelAddCategoryBtn = document.getElementById('cancel-add-category-btn');
    const newCategoryNameInput = document.getElementById('new-category-name');
    const categorySelect = document.getElementById('category-select');
    const categoryError = document.getElementById('category-error');

    addCategoryBtn.addEventListener('click', () => {
        addCategoryForm.style.display = 'block';
        addCategoryBtn.style.display = 'none';
        newCategoryNameInput.focus();
    });

    cancelAddCategoryBtn.addEventListener('click', () => {
        addCategoryForm.style.display = 'none';
        addCategoryBtn.style.display = 'block';
        newCategoryNameInput.value = '';
        categoryError.textContent = '';
    });

    saveCategoryBtn.addEventListener('click', async () => {
        const name = newCategoryNameInput.value.trim();
        if (!name) {
            categoryError.textContent = '分類名稱不能為空。';
            return;
        }
        categoryError.textContent = ''; // Clear previous error

        try {
            const response = await fetch("{{ url_for('notes.add_category') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ name: name })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || '儲存失敗，請稍後再試。');
            }

            // Check if the option already exists to avoid duplicates
            if (!categorySelect.querySelector(`option[value="${data.id}"]`)) {
                const newOption = new Option(data.name, data.id);
                categorySelect.add(newOption);
            }
            
            // Select the new/existing category and hide the form
            categorySelect.value = data.id;
            cancelAddCategoryBtn.click(); // Reuse cancel logic to hide form

        } catch (error) {
            categoryError.textContent = error.message;
        }
    });
});
</script>
{% endblock %}

