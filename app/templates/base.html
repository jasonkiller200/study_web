<!DOCTYPE html>
<html lang="zh-TW" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}個人學習心得記錄分享{% endblock %}</title>
    {% assets "css_all" %}
        <link rel="stylesheet" href="{{ ASSET_URL }}">
    {% endassets %}
    <style>
        .navbar-brand {
            font-weight: bold;
            color: #00bc8c !important; /* Adjusted green to match Darkly's accent */
        }
        .card {
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .badge {
            margin-right: 5px;
        }
        .content-display {
            line-height: 1.6;
        }
        .sidebar {
            /* background-color removed */
            min-height: calc(100vh - 56px);
        }
        pre {
            /* background-color removed */
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('main.index') }}">
                <i class="fas fa-leaf"></i> 個人學習心得
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.index') }}">
                            <i class="fas fa-home"></i> 首頁
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link admin-required" href="{{ url_for('notes.add_note') }}">
                            <i class="fas fa-plus"></i> 新增筆記
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    {% if session.is_admin %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.admin_logout') }}">
                            <i class="fas fa-sign-out-alt"></i> 管理員登出
                        </a>
                    </li>
                    {% endif %}
                </ul>
                <form class="d-flex" method="GET" action="{{ url_for('main.search') }}">
                    <input class="form-control me-2" type="search" name="q" placeholder="搜尋筆記..." 
                           value="{{ search_query if search_query else '' }}">
                    <button class="btn btn-outline-light" type="submit">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 col-lg-2 px-0">
                <div class="sidebar p-3">
                    <h6 class="text-muted mb-3">學習分類</h6>
                    <div class="list-group list-group-flush">
                        <a href="{{ url_for('main.index') }}" 
                           class="list-group-item list-group-item-action {% if not current_category %}active{% endif %}">
                            <i class="fas fa-list"></i> 全部筆記
                        </a>
                        {% for category in categories %}
                        <a href="{{ url_for('main.category_view', category_name=category.name) }}" 
                           class="list-group-item list-group-item-action {% if current_category == category.name %}active{% endif %}">
                            <i class="fas fa-folder"></i> {{ category.name }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <main class="col-md-9 col-lg-10 px-4">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show mt-3" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div class="modal fade" id="admin-login-modal" tabindex="-1" aria-labelledby="adminModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="adminModalLabel">管理員驗證</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>此操作需要管理員權限，請輸入密碼。</p>
            <input type="password" class="form-control" id="admin-password-input" placeholder="管理員密碼">
            <div id="admin-login-error" class="text-danger mt-2" style="min-height: 1.2em;"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" id="admin-login-submit">送出</button>
          </div>
        </div>
      </div>
    </div>


    {% assets "js_all" %}
        <script src="{{ ASSET_URL }}"></script>
    {% endassets %}
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const adminModalElement = document.getElementById('admin-login-modal');
        if (adminModalElement) {
            const adminModal = new bootstrap.Modal(adminModalElement);
            let targetUrl = null;

            document.body.addEventListener('click', function(event) {
                const target = event.target.closest('.admin-required');
                if (target) {
                    event.preventDefault();
                    targetUrl = target.href;
                    
                    const passwordInput = document.getElementById('admin-password-input');
                    const errorDiv = document.getElementById('admin-login-error');
                    
                    passwordInput.value = '';
                    if(errorDiv) errorDiv.textContent = '';
                    
                    adminModal.show();
                }
            });

            const submitButton = document.getElementById('admin-login-submit');
            if (submitButton) {
                submitButton.addEventListener('click', async function() {
                    const passwordInput = document.getElementById('admin-password-input');
                    const password = passwordInput.value;
                    const errorDiv = document.getElementById('admin-login-error');
                    errorDiv.textContent = '';

                    try {
                        const response = await fetch("{{ url_for('main.check_admin') }}", {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ password: password })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && data.success) {
                            adminModal.hide();
                            // Add a small delay to allow modal to hide before redirecting
                            setTimeout(() => { window.location.href = targetUrl; }, 150);
                        } else {
                            errorDiv.textContent = data.message || '驗證失敗。';
                            passwordInput.focus();
                        }
                    } catch (err) {
                        errorDiv.textContent = '發生網路錯誤，請稍後再試。';
                    }
                });
            }

            const passwordInput = document.getElementById('admin-password-input');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault(); // Prevent form submission if it's in a form
                        submitButton.click();
                    }
                });
            }
        }
    });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>